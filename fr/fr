#!/usr/bin/env python3
'''
    %prog - Free Resource Printer - (C) 2005-2018, Mike Miller
    A program to print available free resources in delicious flavors.
    License: GPLv3+.

    usage: %prog [options]

    TODO:

        - make default for fmtstr("")
        - Vol under ssh client?
        - errno to os.EX
        - port ansi to newer module

'''
import sys, os
import errno, locale, math
import shutil
from optparse import OptionParser
from fr import (ansi, fmtstr, fmtval, set_outunit, truncstr, print_meminfo,
                print_diskinfo)

__version__     = '3.00.a100'
out             = sys.stdout.write

# Set defaults
_debug          = False
_binary         = False
_incolor        = 'auto'
_showlbs        = 'auto'
_outunit        = 1000000, 'Megabyte'  # 1 Megabyte default
_graphwidth     = 0
_precision      = -1
_colwidth       = 10
_extra_cols_at  = 110
_extra_cols_cap = 4

# discover environment, must be done before colorama to avoid crash on win
totcols, _ = shutil.get_terminal_size((80, 20))  # fallback

plat = sys.platform[:3]
if plat == 'lin':
    import fr.linux as pform
elif plat == 'win':
    import fr.windows as pform
elif plat == 'dar':
    import fr.darwin as pform


def setup():
    'Parse, interpret command line options, discover environment.'
    from argparse import ArgumentParser
    parser = ArgumentParser(usage=__doc__.rstrip())
    parser.add_argument('-a', '--all', action='store_true',
                        help='Include unmounted devices and tmpfs mounts.')
    parser.add_argument('-b', '--binary',
                        action='store_true', dest='binary', default=_binary,
                        help='Use propeller-head binary units (2^10) instead of '
                        'human/SI units (10^3).')
    parser.add_argument('-d', '--debug',
                        action='store_true', dest='debug', default=_debug,
                        help='Turns on verbose debugging output.')
    parser.add_argument('-l', '--local', action='store_true',
                        help='Include only local filesystems.')
    parser.add_argument('-p', '--precision', type=int, default=_precision,
                        metavar='#', help='Set the number of dec. places shown.')
    parser.add_argument('-r', '--relative', action='store_true',
                        help='Use logarithmic relative disk graph sizes.')

    unit_choices = ('b', 'k', 'm', 'g', 't')
    parser.add_argument('-u', '--unit', default='m', choices=unit_choices,
                        metavar='U', help='Selects the unit size: b, k, m, g, t')
    parser.add_argument('-w', '--width', type=int, metavar='#',
                        default=_graphwidth,
                        help='Set the width of the resource graphs.')

    toggle_choices = ('auto', 'on', 'off')
    parser.add_argument('--color', dest='incolor',
                        default=_incolor, choices=toggle_choices, metavar='...',
                        help='Color: (%s)' % ', '.join(toggle_choices))
    parser.add_argument('--labels', default=_showlbs,
                        choices=toggle_choices, metavar='...', dest='showlbs',
                        help='Show volume label column: (%s)' %
                        ', '.join(toggle_choices))
    parser.add_argument('--version', action='version',
                        version='%(prog)s ' + __version__)

    opts = parser.parse_args()

    # check environment
    isatty = hasattr(sys.stdout, 'fileno') and os.isatty(sys.stdout.fileno())
    if not isatty:  # must encode for file redirection
        import codecs
        sys.stdout = codecs.getwriter('utf-8')(sys.stdout)
    # determine whether to use color
    opts.hicolor = None
    if opts.incolor == 'auto':
        if isatty:
            if 'NO_COLOR' in os.environ:
                opts.incolor = False
            elif pform.coloravail:
                opts.incolor = True
                opts.hicolor = pform.hicolor
            else:
                opts.incolor = False
        else:
            opts.incolor = False
    elif opts.incolor == 'on':
        if pform.coloravail:
            opts.incolor = True
            opts.hicolor = pform.hicolor
        elif plat == 'win':
            print('\nError: color support not available.  Install colorama:')
            print('       pip install colorama\n')
    else:
        opts.incolor = False

    # determine whether to show volume column, no under SSH?
    if opts.showlbs == 'auto':
        if 'SSH_CLIENT' in os.environ:
            opts.showlbs = False
        else:
            opts.showlbs = True
    elif opts.showlbs == 'on':
        opts.showlbs = True
    else:
        opts.showlbs = False

    opts.columns = totcols
    # expand colwidth if room, one column extra per ten over threshold
    colwidth = _colwidth
    extrawidth = opts.columns - _extra_cols_at
    if extrawidth > 0:
        colwidth += min(extrawidth // 10, _extra_cols_cap)  # cap at

    return opts, colwidth


def main():
    ''' Let's get it on... '''
    incolor     = opts.incolor  # cache
    longestpth  = colwidth + 1  # extra space
    widelayout  = opts.columns > 89
    numcols     = 6
    if not widelayout:          # might as well, we have space
        opts.showlbs = True
    if not opts.showlbs:
        numcols = 5

    if opts.binary:
        outunit, unitstr = set_outunit('-%sb' % opts.unit.lower())
    else:
        outunit, unitstr = set_outunit('-%s' % opts.unit.lower())
    if opts.debug:
        print('opts:', opts)    # or will get clobbered by set
        print('unitstr:', unitstr)

    # Level One Diagnostic
    outunit_fmt = fmtval(outunit, override_prec=0, spacing=False, trunc=False)
    out(f'\nFree Resources in Blocks of 1 {unitstr} ({outunit_fmt} bytes)')

    meminfo = pform.get_meminfo(outunit, debug=opts.debug)
    if not meminfo:
        print('\nError: Could not read memory information.')
        sys.exit(errno.EIO)

    diskinfo = pform.get_diskinfo(outunit,
                                  debug=opts.debug,
                                  local_only=opts.local,
                                  show_all=opts.all,
                                  )
    if not diskinfo:
        print('\nError: Could not read disk information.')
        sys.exit(errno.EIO)

    print() # after possible diskinfo/dbus/udisks warning
    # figure out graph width
    for disk in diskinfo:
        pathlen = len(disk.mntp)
        if pathlen > longestpth:
            longestpth = pathlen

    # cap longest path
    dwidth = colwidth * 2
    longestpth = longestpth if longestpth < dwidth else dwidth

    if not opts.width:  # automatic width
        #         rm path col,   add space each, return path col, graph padding
        taken = ((numcols - 1) * (colwidth + 1)) + longestpth + 4
        if widelayout:
            opts.width = opts.columns - taken
        else:
            opts.width = 58

    # Headers
    print()
    out(fmtstr('DEVICE', leftjust=True))
    if opts.showlbs:
        out(fmtstr('VOLUME', leftjust=True))
    for header in ['CAPACITY', 'USED', 'FREE']:
        out(fmtstr(header))

    if widelayout:
        if ' ' in pform.col_lblw:   # figure expanding label (on posix)
            lbl = list(pform.col_lblw)
            while len(lbl) < colwidth:
                lbl.insert(5, ' ')
            lbl = ''.join(lbl)
            extspace = 2
        else:
            lbl = pform.col_lblw    # win
            extspace = 3
        out(f'{" " * (opts.width + extspace)} {fmtstr(lbl)}')
    else:
        out('  ' + fmtstr(pform.col_lbls))
    print()
    print_meminfo(meminfo, widelayout, incolor)
    print_diskinfo(diskinfo, widelayout, incolor)


if __name__ == '__main__':
    opts, colwidth = setup()

    import fr  #Â make constants avail in other module  :-/
    fr.opts = opts
    fr.colwidth = colwidth
    fr.plat = plat
    fr.pform = pform
    fr.load_icons()

    sys.exit(main())
